#compdef vagrant

_vagrant() {
    local curcontext="$curcontext" state line url
    typeset -A opt_args

    _arguments \
        '1:Subcommando:(box destroy halt init package plugin provision reload resume ssh ssh-config status suspend up)' \
        '2:VMs:->box'

    case $state in
    box)
        if [[ -f Vagrantfile ]]; then
            egrep -o "config.vm.define :[a-z0-9]+" Vagrantfile | cut -d" " -f2 | while IFS= read -r vm; do compadd ${vm#:}; done
        else
            _files
        fi
    ;;
    esac
}

_vagrant "$@"